From 59143eeef9042f3c9996a06d21a5fe05dc870dcd Mon Sep 17 00:00:00 2001
From: Andrey Butirsky <butirsky@gmail.com>
Date: Fri, 8 Oct 2021 15:21:48 +0300
Subject: [PATCH] [wayland] fix crash on startup with lv3:ralt_alt XKB option

With lv3:ralt_alt ("Right Alt never chooses 3rd level") option set, we
get more layouts from libxkbcommon than it was configured, see:
https://github.com/xkbcommon/libxkbcommon/issues/262
It might be correct lib's behavior, still.

The extra layouts are redundant, so we strip them out from usual usage.

BUG: 440027
---
 src/xkb.cpp | 4 ++--
 src/xkb.h   | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/xkb.cpp b/src/xkb.cpp
index e82de0a6c1..cb96207ba7 100644
--- a/src/xkb.cpp
+++ b/src/xkb.cpp
@@ -413,9 +413,9 @@ QString Xkb::layoutName() const
     return layoutName(m_currentLayout);
 }
 
-const QString &Xkb::layoutShortName(int index) const
+QString Xkb::layoutShortName(int index) const
 {
-    return m_layoutList.at(index);
+    return m_layoutList.value(index);
 }
 
 void Xkb::updateConsumedModifiers(uint32_t key)
diff --git a/src/xkb.h b/src/xkb.h
index e610d37ae6..11524cc028 100644
--- a/src/xkb.h
+++ b/src/xkb.h
@@ -89,7 +89,7 @@ public:
     }
     QString layoutName(xkb_layout_index_t index) const;
     QString layoutName() const;
-    const QString &layoutShortName(int index) const;
+    QString layoutShortName(int index) const;
     quint32 numberOfLayouts() const;
 
     /**
-- 
GitLab

